<?php

/**
 * @file
 * Contains sitenow_p2lb.module.
 */

use Drupal\Core\Database\Database;
use Drupal\layout_builder\Section;

/**
 * Check for nodes which are using paragraphs.
 */
function sitenow_p2lb_paragraph_nodes() {
  $connection = Database::getConnection();
  $query = $connection->select('paragraphs_item_field_data', 'pifd');
  $query->fields('pifd', ['parent_id'])
    ->condition('parent_type', 'node', '=');
  $result = $query->distinct()
    ->execute()
    ->fetchCol();
  // @todo Paragraphs used for lb collections need to be filtered out.
  return $result;
}

/**
 * Convert a node from paragraphs to layout builder.
 */
function sitenow_p2lb_node_p2lb($nid) {
  $node = \Drupal::service('entity_type.manager')
    ->getStorage('node')
    ->load($nid);
  // Get sections from the page.
  $section_ids = sitenow_p2lb_fetch_section_ids($nid);
  $layout = $node->get('layout_builder__layout');
  foreach ($section_ids as $section_id) {
    $layout = sitenow_p2lb_process_section($section_id, $layout);
  }
  // Need to set with an array of sections, retreived with getSections().
  $node->set('layout_builder__layout', $layout->getSections())
    ->save();
}

/**
 * Fetch all section paragraph ids attached to a node.
 */
function sitenow_p2lb_fetch_section_ids($nid) {
  $connection = Database::getConnection();
  $query = $connection->select('paragraphs_item_field_data', 'pifd');
  $query->fields('pifd', ['id'])
    ->condition('parent_type', 'node', '=')
    ->condition('parent_id', $nid, '=');
  $section_ids = $query->distinct()
    ->execute()
    ->fetchCol();
  return $section_ids;
}

/**
 * Process paragraphs section.
 */
function sitenow_p2lb_process_section($section_id, $layout) {
  $para_storage = \Drupal::service('entity_type.manager')
    ->getStorage('paragraph');

  // Grab section title.
  $section_object = $para_storage->load($section_id);
  $section_title = ($section_object->get('field_section_title')[0]) ?
    $section_object->get('field_section_title')[0]->getValue()['value'] : '';

  $connection = Database::getConnection();
  $query = $connection->select('paragraphs_item_field_data', 'pifd');
  $query->fields('pifd', ['id'])
    ->condition('parent_id', $section_id, '=')
    ->condition('parent_field_name', 'field_section_content_block', '=');
  $pids = $query->execute()->fetchCol();

  $col_widths = [];
  $p2b_ids = [];
  $paragraphs = $para_storage->loadMultiple($pids);
  foreach ($paragraphs as $paragraph) {
    $col_str = $paragraph->get('field_uip_colwidth')->getString();
    // 'Fluid' paragraph will be a col_width of 0.
    $col_widths[] = (int) preg_replace('|[^0-9]|', '', $col_str);
    $p2b_ids[] = sitenow_p2lb_process_paragraph($paragraph);
  }

  $sections_info = sitenow_p2lb_determine_columns($col_widths);

  $paragraph_iter = 0;
  $paragraph_keys = array_keys($paragraphs);
  foreach ($sections_info as $section_info) {
    $num_cols = (isset($section_info['num_columns'])) ? $section_info['num_columns'] : 1;
    // Create and append section to our $layout (section list).
    $w2d = [1 => 'one', 2 => 'two', 3 => 'three', 4 => 'four'];
    $formatter = (isset($w2d[$num_cols])) ? $w2d[$num_cols] : 'four';
    $layout_id = 'layout_'
      . $formatter
      . 'col';
    $layout_settings = [
      'label' => $section_title,
      'column_widths' => sitenow_p2lb_determine_columns($section_info['col_widths']),
      'layout_builder_styles_style' => [],
    ];
    $section_array = sitenow_p2lb_create_section_array($layout_id, $layout_settings);
    for ($i = 0; $i < $num_cols; $i++) {
      $key = $paragraph_keys[$paragraph_iter++];
      $block_config = sitenow_p2lb_process_paragraph($paragraphs[$key]);
      if (!empty($block_config)) {
        // $section->appendComponent($block_config);
        $uuid = $block_config['uuid'];
        $config = $block_config['configuration'];
        $section_array['components'][$uuid] = [
          'uuid' => $uuid,
          'region' => 'content',
          'configuration' => $config,
          'additional' => [],
          'weight' => 0,
        ];
      }
    }
    $section = Section::fromArray($section_array);
    $layout->appendSection($section);
    // @todo append associated paragraphs, as well as possible error handling.
  }
  return $layout;
}

/**
 * Process individual paragraph.
 */
function sitenow_p2lb_process_paragraph($paragraph) {
  if (empty($paragraph)) {
    return [];
  }
  switch ($paragraph->get('type')->getString()) {
    case 'section':
    case 'accordion':
    case 'accordion_item':
    case 'blockquote':
    case 'image_gallery':
    case 'webform':
    case 'featured_content':
    case 'carousel':
    case 'carousel_image':
      break;

    case 'text':
      // @todo This needs to be checked/extended/cleaned up
      $type = 'uiowa_text_area';
      // @todo update labeling methodology.
      $label = 'title';
      $block = \Drupal::entityTypeManager()
        ->getStorage('block_content')
        ->create([
          'type' => 'uiowa_text_area',
          'langcode' => 'en',
          'status' => $paragraph->get('status')->getString(),
          // info- looks like 'title' field?
          'reusable' => 0,
          'default_langcode' => 1,
          'field_uiowa_text_area' => [
            'value' => $paragraph->get('field_text_body')[0]->get('value')->getString(),
            'format' => $paragraph->get('field_text_body')[0]->get('format')->getString(),
          ],
        ]);
      break;

    case 'card':
      // @todo This needs to be checked/extended/cleaned up
      $type = 'uiowa_card';
      $image = ($paragraph->get('field_card_image')->getValue()) ?
        $paragraph->get('field_card_image')->getValue()[0]['target_id'] : '';

      $link = ($paragraph->get('field_card_link')->getValue()) ?
        $paragraph->get('field_card_link')->getValue()[0] : '';

      $title = ($paragraph->get('field_card_title')->getValue()) ?
        $paragraph->get('field_card_title')->getValue()[0]['value'] : '';

      $block = \Drupal::entityTypeManager()
        ->getStorage('block_content')
        ->create([
          'type' => 'uiowa_card',
          'langcode' => 'en',
          'status' => $paragraph->get('status')->getString(),
          'info' => 'Card',
          'reusable' => 0,
          'default_langcode' => 1,
          'field_uiowa_card_author' => [],
          'field_uiowa_card_excerpt' => [
            'value' => $paragraph->get('field_card_body')[0]->get('value')->getString(),
            'format' => $paragraph->get('field_card_body')[0]->get('format')->getString(),
          ],
          'field_uiowa_card_image' => $image,
          'field_uiowa_card_link' => $link,
          'field_uiowa_card_title' => [
            'size' => 'h2',
            'text' => $title,
          ],
        ]);
      break;

    default:

  }
  if (isset($block) && $block->save()) {
    $uuid = $block->get('uuid')->getValue()[0]['value'];
    $config = [
      'id' => 'inline_block:' . $type,
      'label' => $title,
      'provider' => 'layout_builder',
      // @todo update labeling methodology.
      'label_display' => 1,
      'block_revision_id' => $block->getRevisionId(),
      'view_mode' => '',
    ];
    return [
      'configuration' => $config,
      'uuid' => $uuid,
    ];
  }
  // No block was successfully created.
  return [];
}

/**
 * Removes all attached paragraphs from a node.
 */
function sitenow_p2lb_remove_attached_paragraphs($nid) {
  $section_ids = sitenow_p2lb_fetch_section_ids($nid);
  // Grab paragraphs attached to each of the given sections.
  $connection = Database::getConnection();
  $query = $connection->select('paragraphs_item_field_data', 'pifd');
  $query->fields('pifd', ['id'])
    ->condition('parent_id', $section_ids, 'in')
    ->condition('parent_field_name', 'field_section_content_block', '=');
  $child_ids = $query->execute()->fetchCol();
  $ids = array_merge($child_ids, $section_ids);
  $paragraphs = \Drupal::service('entity_type.manager')
    ->getStorage('paragraph')
    ->loadMultiple($ids);
  foreach ($paragraphs as $paragraph) {
    $paragraph->delete();
  }
}

/**
 * Determine section layout_id.
 */
function sitenow_p2lb_determine_columns($col_widths) {
  $sections = [];
  // Check if we wrap into additional sections.
  $total_col_width = array_sum($col_widths);
  if ($total_col_width <= 12) {
    // Check for 'fluid' paragraphs, and set appropriately.
    $fluid_indices = array_keys($col_widths, 0, TRUE);
    if (!empty($fluid_indices)) {
      $repl = (12 - $total_col_width) / count($fluid_indices);
      // Roundoff to a valid repl value.
      if ($repl <= 3) {
        $repl = 3;
      }
      elseif ($repl <= 4) {
        $repl = 4;
      }
      elseif ($repl <= 6) {
        $repl = 6;
      }
      elseif ($repl <= 8) {
        $repl = 8;
      }
      elseif ($repl <= 9) {
        $repl = 9;
      }
      else {
        $repl = 12;
      }
      foreach ($fluid_indices as $index) {
        $col_widths[$index] = $repl;
      }
      // Reiter with the updated colwidths, in case they run to new section.
      sitenow_p2lb_determine_columns($col_widths);
    }
    $sections[] = ['num_columns' => count($col_widths), 'col_widths' => $col_widths];
    return $sections;
  }
  $iter_adder = 0;
  $i = 0;
  $counter = 100;
  while (TRUE) {
    $iter_adder += $col_widths[$i];
    if ($iter_adder > 12) {
      $sections = array_merge($sections,
        sitenow_p2lb_determine_columns(array_slice($col_widths, 0, $i)),
        sitenow_p2lb_determine_columns(array_slice($col_widths, $i)),
      );
      $iter_adder = 0;
    }
    if ($i == count($col_widths) - 1) {
      $sections = array_merge($sections,
        sitenow_p2lb_determine_columns(array_slice($col_widths, $i))
      );
      break;
    }
    // Extra check to break loop.
    if ($counter-- <= 0) {
      break;
    }
    $i++;
  }
  return $sections;
}

/**
 * Create a section.
 */
function sitenow_p2lb_create_section_array($layout_id, $layout_settings) {
  $section_array = [
    'layout_id' => $layout_id,
    'components' => [],
    'layout_settings' => $layout_settings,
  ];

  return $section_array;
}

/**
 * Choose multi-col column settings.
 */
function sitenow_p2lb_multicol_settings($col_widths) {
  $settings = '';
  switch (count($col_widths)) {
    case 2:
      $options = [
        3 => '25-75',
        4 => '33-67',
        6 => '50-50',
        8 => '67-33',
        9 => '75-25',
      ];
      $picker = $col_widths[0];
      if (in_array($picker, $options)) {
        $settings = $options[$picker];
      }
      else {
        $settings = $options[6];
      }
      break;

    case 3:
      if ($col_widths[0] == 6) {
        $settings = '50-25-25';
      }
      elseif ($col_widths[0] == 3) {
        if ($col_widths[1] == 3) {
          $settings = '25-25-50';
        }
        else {
          $settings = '25-50-25';
        }
      }
      else {
        $settings = '33-34-33';
      }
      break;

    case 1:
    case 4:
    default:
      break;
  }
  return $settings;
}
